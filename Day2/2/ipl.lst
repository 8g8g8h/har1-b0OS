     1                                  ; FAT12 format
     2                                  ;これはブートセクタを作成
     3                                  ;つまりここからos本体をロードするために必要なもの
     4                                  ; ブートセクタ (512バイト)
     5                                  ; > 0x00007c00 - 0x00007dff ： ブートセクタが読み込まれるアドレス
     6                                  
     7                                  
     8                                  
     9                                  ; このプログラムがメモリ上のどこによみこまれるのか
    10                                  
    11                                          ORG     0x7c00
    12                                  
    13                                  ; ディスクのための記述
    14                                          ; BPB(BIOS Parameter Block)
    15                                                                  ; Name             | Offset              | Byte | Description
    16                                                                  ;                                               | 
    17                                  ; FAT12/16/32共通フィールド(オフセット0～35)
    18 00000000 EB4E                            JMP     entry           ; BS_JmpBoot       | 0x0000-0x0002 0-2   |    3 | Jump to Bootstrap
    19 00000002 90                              DB      0x90            ;                                               | ブートストラッププログラムへのジャンプ命令(x86命令)。
    20                                                                  ;                                               | 0xEB, 0x??, 0x90 (ショート ジャンプ+NOP)
    21 00000003 686172312D62306970-             DB      "har1-b0ipl"    ; BS_OEMName       | 0x0003-0x000a 3-10  |    8 | これは単なる名前である
    21 0000000C 6C                 
    22 0000000D 0002                            DW      512             ; BPB_BytsPerSec   | 0x000b-0x000c 11-12 |    2 | セクタあたりのバイト数.
    23                                                                  ;                                               | Bytes Per Cluster
    24 0000000F 01                              DB      1               ; BPB_SecPerClus   | 0x000d           13 |    1 | アロケーションユニット(割り当て単位)当たりのセクタ数
    25                                                                  ;                                               | アロケーションユニットはクラスタと呼ばれている
    26                                                                  ;                                               | Secters Per Cluster
    27 00000010 0100                            DW      1               ; BPB_RsvdSecCnt   | 0x000e-0x000f 14-15 |    2 | 予約領域のセクタ数 (少なくとも
    28                                                                  ;                                               | このBPB(BIOS Parameter Block)を含むブート
    29                                                                  ;                                               | セクタそれ自身が存在するため0であってはならない)
    30 00000012 02                              DB      2               ; BPB_NumFATs      | 0x0010           16 |    1 | FATの個数                     ;                                               | (このフィールドの値は常に2に設定す
    31 00000013 E000                            DW      224             ; BPB_RootEntCnt   | 0x0011-0x0012 17-18 |    2 | FAT12/16ボリュームではルートディレクトリに
    32                                                                  ;                                               | 含まれるディレクトリエントリの数を示す.
    33                                                                  ;                                               | このフィールドにはディレクトリテーブルのサイズが
    34                                                                  ;                                               | 2セクタ境界にアライメントする値,つまり,
    35                                                                  ;                                               | BPB_RootEntCnt*32がBPB_BytsPerSecの偶数倍になる値
    36                                                                  ;                                               | を設定すべきである. (32というのはディレクトリエントリ1個のサイズ)
    37                                                                  ;                                               | 最大の互換性のためにはFAT16では512に設定すべき.
    38                                                                  ;                                               | FAT32ボリュームではこのフィールドは使われず,
    39                                                                  ;                                               | 常に0でなければならない.
    40                                                                  ;                                               | 224x32=4x16x32=4x512
    41                                                                  ;                                               | 512=32x16
    42                                                                  ;                  |                     |      | 
    43 00000015 400B                            DW      2880            ; BPB_TotSec16     | 0x0013-0x0014 19-20 |    2 | ボリュームの総セクタ数(古い16ビットフィールド).
    44                                  				;
    45                                  ;| １セクタが512byte そのセクタが2880個ある。（フロッピーディスクは1440KB 1440KB/512=2880）
    46                                                                  ;   				                                             						        | ボリュームの4つの領域全てを含んだセクタ数.
    47                                                                  ;                                               | FAT12/16でボリュームのセクタ数が0x10000以上になる
    48                                                                  ;                                               | ときは,このフィールドには無効値(0)が設定され,真の
    49                                                                  ;                                               | 値がBPB_TotSec32に設定される.
    50                                                                  ;                                               | FAT32ボリュームでは,このフィールドは必ず無効値で
    51                                                                  ;                                               | なければならない.
    52                                                                  ;                                               | 0x10000=(2^4)^4=65536 > 2880
    53                                                                  ;                  |                     |      | 
    54 00000017 F0                              DB      0xf0            ; BPB_Media        | 0x0015           21 |    1 | 区画分けされた固定ディスクドライブでは0xF8が標準
    55                                                                  ;                                               | 値である. 区画分けされないリムーバブルメディアで
    56                                                                  ;                                               | は0xF0がしばしば使われる. このフィールドに有効な
    57                                                                  ;                                               | 値は,0xF0,0xF8,0xF9,0xFA,0xFB,0xFC,0xFD,0xFE,0xFF
    58                                                                  ;                                               | で,ほかに重要な点はこれと同じ値をFAT[0]の下位8
    59                                                                  ;                                               | ビットに置かなければならないということだけである.
    60                                                                  ;                                               | これはMS-DOS 1.xでメディアタイプの設定に遡り,
    61                                                                  ;                                               | 既に使われていない。
    62                                                                  ;                  |                     |      | 
    63 00000018 0900                            DW      9               ; BPB_FATSz16      | 0x0016-0x0017 22-23 |    2 | 1個のFATが占めるセクタ数.
    64 0000001A 1200                            DW      18              ; BPB_SecPerTrk    | 0x0018-0x0019 24-25 |    2 | トラック当たりのセクタ数
    65 0000001C 0200                            DW      2               ; BPB_NumHeads     | 0x001a-0x001b 26-27 |    2 | ヘッドの数
    66 0000001E 00000000                        DD      0               ; BPB_HiddSec      | 0x001c-0x001f 28-31 |    4
    67                                                                  ;     
    68 00000022 00000000                        DD      0               ; BPB_TotSec32     | 0x0020-0x0023 32-35 |    4 | FAT32ボリュームでは常に有効値が入る.
    69                                  
    70                                                                  ; Name             | Offset              | Byte | Description
    71                                                                  ;                  |                     |      | 
    72 00000026 00                              DB      0x00            ; BS_DrvNum        | 0x0024           36 |    1 |
    73 00000027 00                              DB      0x00            ; BS_Reserved1     | 0x0025           37 |    1 |
    74 00000028 29                              DB      0x29            ; BS_BootSig       | 0x0026           38 |    1 |
    75                                  
    76 00000029 FFFFFFFF                        DD      0xffffffff      ; BS_VolID         | 0x0027-0x002a 39-42 |    4 | ボリュームシリアル番号
    77 0000002D 686172312D62304F53              DB      "har1-b0OS"     ; BS_VolLab        | 0x002a-0x0036 43-54 |   11 | ディスクの名前
    78 00000036 4641543132202020                DB      "FAT12   "      ; BS_FilSysType    | 0x0036-0x003d 54-61 |    8 | フォーマットの名前
    79 0000003E <res 00000012>                  RESB    18              ;                  | 0x003e-0x004f 62-79 |    8 | 18バイト空けて 0x7c50 の直前まで埋める
    79          ******************       warning: uninitialized space declared in .text section: zeroing
    80                                  
    81                                  
    82                                  entry:
    83 00000050 B80000                          MOV     AX, 0           
    84 00000053 8ED0                            MOV     SS, AX
    85 00000055 BC007C                          MOV     SP, 0x7c00
    86 00000058 8ED8                            MOV     DS, AX
    87 0000005A 8EC0                            MOV     ES, AX
    88                                  
    89 0000005C BE[7400]                        MOV     SI, msg
    90                                  putloop:
    91 0000005F 8A04                            MOV     AL, BYTE [SI]   ; BYTE (accumulator low)
    92 00000061 83C601                          ADD     SI, 1           ; increment stack index
    93 00000064 3C00                            CMP     AL, 0           ; compare (<end msg>)
    94 00000066 7409                            JE      fin             ; jump to fin if equal to 0
    95                                  
    96                                                                  ; 一文字表示(INTの設定について)
    97 00000068 B40E                            MOV     AH, 0x0e        ; AH = 0x0e
    98 0000006A BB0F00                          MOV     BX, 15          ; BH = 0, BL = <color code>
    99 0000006D CD10                            INT     0x10            ; interrupt BIOS
   100                                  
   101 0000006F EBEE                            JMP     putloop
   102                                  fin:
   103 00000071 F4                              HLT
   104 00000072 EBFD                            JMP     fin
   105                                  
   106                                  msg:
   107 00000074 0A0A                            DB      0x0a, 0x0a
   108 00000076 746869732069732061-             DB      "this is a test"
   108 0000007F 2074657374         
   109 00000084 0A                              DB      0x0a
   110 00000085 00                              DB      0               ; end msg
   111                                  
   112 00000086 <res 00000178>                  RESB    0x1fe-($-$$)    ; 現在の場所から 0x1fd (0x1fe の直前)
   112          ******************       warning: uninitialized space declared in .text section: zeroing
   113                                                                  ; まで(残りの未使用領域)を0で埋める
   114                                                                  ; (naskでは0で初期化するみたいだがnasm
   115                                                                  ; だと初期化しない) 
   116                                                                  ; 0x7dfe-0x7c00 = 32254−31744 = 510
   117 000001FE 55AA                            DB      0x55, 0xaa      ; BS_BootSign    | 0x7dfe-0x7dff       | 510  |
