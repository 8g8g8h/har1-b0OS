PICについて

割り込みを行うためにPICの設定が必要である。

PICとは、設定可能な割り込みコントローラである。
これはCPU自体が１つしか割り込みを行えない設定になっており、CPUの８本の割り込み信号(IRQ)を一つにまとめたものである。

割り込みをCPUに教えるためのまとめ役みたいなもの。

実際CPUには15個のピンがあり、それらから割り込みが来たかどうかをチェックしている。

PICには、マスターとスレーブの2つがある。

ピンの管理は、マスタは0~7番までをスレーブは8~15番までを管理している

IRQ＝ピンとして考える。

IRQの２番がマスターとスレーブをつなげている。

これらのPICの情報を保存するレジスタがある。すべて8bitである。それがIMR、ICWである。

IMRは割り込みの受付についてのレジスタである。

IMRは、８ビットがそれぞれIRQの8個に対応している

このビットが１になっているとPICからの割り込みを受付ないようにする

ICWは、初期化制御のためのレジスタである。

ICWは１〜４まであり合計で4byte

ICW1、3、4はそれぞれきまっていることなのでスルーでオッケー。

ちなみにICW3は、マスタースレーブの設定である。
マスタスレーブは8個しか使えないので以下のような設定になる。

PIC0は1<<2としている。これにより00000100となる

ICW2について設定することが重要である。

ICW2は、IRQをどの割り込み番号としてCPUに通知するかを決めたもの

INT 10とは、0xcd 0x10として書いている。

このように番号を設定する必要がある。ここでは、先に番号をIRQと連動させることを行っている。

今回の例では、IRQ0~7にそれぞれ割り込み番号20~27を設定。
IRQ8~15に27~2fを設定している。

io_out8(PIC0_IMR ,0xfb)
これは実際ここでは、リトルエンディアンとして入るので、01000000となり、IRQ2を示していることになる。

int.cでは先程の設定で番号とpicの対応ができたのでそれ以外の番号と割り込みをIDTに設定することを行う。

キーボードのキーが押されたときの割り込みの流れ

①　PICからIRQピンに各周辺デバイスから割り込み要求がある。

②　PICからCPUに向けて割り込み要求が出される。

③　CPUからPICに割り込みを受け付けたことを返信する。

④　PICはCPUに対して割り込みベクタ番号を出力する。

⑤　CPUはIDT(Interrupt Descriptor Table)を見て割り込みの処理にうつる。

inthandler21は、実際にキーボードが押されたときに起こる動作をまとめている。

では、実際にキーボードが押されたときにcpuに情報を教えるために設定する順番を以下に示す。

 set_gatedesc(idt+0x21,(int) asm_inthandler21,2*8, AR_INTGATE32);
    set_gatedesc(idt+0x27, (int) asm_inthandler27, 2*8,AR_INTGATE32);
    set_gatedesc(idt+0x2c, (int) asm_inthandler2c,2*8,AR_INTGATE32);

ここでidtの設定を行っている。
引数の2個めは、その割り込みに関しての場所の情報を示している。

それについて書いているのは、asm_inthandler21の場所(nasmfuncのラベルの場所がアドレスであり)に書いてあるのでそのオフセットを示している。

これにより、割り込みされた(キーボードが押された)ときにasm_inthandler21を実行するようになっている。

IDTでは、オフセットの場所からIDTについての命令をcpuに読み込ませて、実行させる。

asm_inthandler21で行っていることは、

割り込みを行う前のレジスタの値をスタックに入れて、
inthandler21で割り込みが起きた際に起こる処理であるinthandler21を読んで実行。その実行が終わったら先程のスタックの情報をもとに戻して終了である。

キーボードの一連の動作について

①:最初にPICの設定を行う(PICで割り込みを許可する+idtの21番にキーボードが押されたときの動作を書いておく。それは、asm_inthandlerで最初にレジスタの情報をスタックに積んで、割り込んだときに画面に表示するinthandler21を呼び出し、それらが終わったら先程のスタックの情報をレジスタに戻す)

②:ここでボダンを押す

そのときに行われるのは先程の順番で行われる。

キーボードのキーが押されたときの割り込みの流れ

①　PICからIRQピンに各周辺デバイスから割り込み要求がある。

②　PICからCPUに向けて割り込み要求が出される。

③　CPUからPICに割り込みを受け付けたことを返信する。

④　PICはCPUに対して割り込みベクタ番号を出力する。

⑤　CPUはIDT(Interrupt Descriptor Table)を見て割り込みの処理にうつる。
